# Cross-Site Scripting (XSS) – Exploiting XSS to Bypass CSRF Defenses
(Web Security Academy)

This lab demonstrates how a **stored XSS vulnerability** can be chained with **CSRF token theft** to bypass CSRF protections and perform **unauthorized state-changing actions** on behalf of a victim.

---

## Lab: Exploiting XSS to Bypass CSRF Defenses

**Category:** Cross-site scripting  
**Type:** Stored XSS  
**Exploitation:** CSRF token theft  
**Level:** Practitioner  
**Status:** Solved  

---

## What This Lab Is About

This lab contains a **stored XSS vulnerability** in the blog comment functionality.

Key scenario:

- A victim user views blog comments
- The application uses **CSRF tokens** to protect sensitive actions
- The attacker uses XSS to:
  - Load the victim’s account page
  - Extract the CSRF token
  - Perform an authenticated action using the stolen token

The goal is to **change the victim’s email address** without their consent.

---

## Vulnerable Flow

- **Source:** Blog comment input
- **Sink:** Stored JavaScript executed in victim’s browser
- **Sensitive Data:** CSRF token
- **Protected Action:** Email address change

---

## Target Functionality

The email update feature requires:

- `POST /my-account/change-email`
- Parameters:
  - `email`
  - `csrf` (anti-CSRF token)

The CSRF token is embedded in the HTML as a hidden input field.

---

## Payload Used

```html
<script>
var req = new XMLHttpRequest();
req.onload = handleResponse;
req.open('get','/my-account',true);
req.send();

function handleResponse() {
    var token = this.responseText.match(/name="csrf" value="(\w+)"/)[1];
    var changeReq = new XMLHttpRequest();
    changeReq.open('post', '/my-account/change-email', true);
    changeReq.send('csrf='+token+'&email=test@test.com')
};
</script>
````

---

## Steps I Followed

1. Logged in using the provided credentials:

   ```
   wiener:peter
   ```
2. Visited the **My Account** page
3. Inspected the page source
4. Identified:

   * Email change endpoint
   * Hidden CSRF token field
5. Crafted an XSS payload to:

   * Load `/my-account`
   * Extract the CSRF token using regex
   * Send a forged POST request with the stolen token
6. Posted the payload as a blog comment
7. Waited for the victim to view the comment
8. The victim’s email was automatically changed
9. Lab marked as solved

---

## Why This Worked

* Stored XSS executes in the victim’s authenticated session
* Same-origin policy allows reading responses from `/my-account`
* CSRF tokens are accessible in raw HTML
* CSRF protections assume JavaScript cannot read tokens
* XSS completely breaks CSRF defenses

---

## Impact

* CSRF protections rendered useless
* Unauthorized account modifications
* Account takeover potential
* Trust boundary between client and server broken

---

## Key Lessons Learned

* CSRF tokens do **not** protect against XSS
* XSS + CSRF = full account compromise
* Tokens embedded in HTML are readable via JavaScript
* Stored XSS is extremely dangerous
* Defense-in-depth is critical

---

## Defensive Takeaways

To prevent this attack:

* Eliminate XSS vulnerabilities
* Use Content Security Policy (CSP)
* Apply strict output encoding
* Use SameSite cookies where possible
* Avoid exposing sensitive tokens to JavaScript

---

## Final Summary

* Stored XSS used to execute JavaScript in victim’s session
* CSRF token extracted from account page
* Token reused to perform protected action
* Victim’s email changed without consent
* Demonstrates why XSS is more severe than CSRF

 
